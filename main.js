"use strict";function getAllElementsWithDepth_(t,e,s,i){for(const n of Object.keys(t)){const o=Number.parseInt(n,10),a=t[o],r=i.concat([o]);0===e?s.push({keys:r,element:a}):getAllElementsWithDepth_(a,e-1,s,r)}}function getAllElementsWithDepth(t,e){const s=[];return getAllElementsWithDepth_(t,e,s,[]),s}function dictFromTwoLists(t,e){const s={};for(let i=0;i<t.length;i++)s[t[i]]=e[i];return s}function matchDict(t,e){for(const s in e)if(t[s]!=e[s])return!1;return!0}class Root extends React.Component{constructor(t){super(t),this.state={board:void 0,game_state:void 0,selected_cell:void 0,config_text:void 0,config:default_config},this.state.config_text=JSON.stringify(this.state.config),this.state=Object.assign(this.state,this.compile_()),this.actions={swap:(t,e,s)=>{this.setByCoordinates(t,e,s),this.setByCoordinates(e,t,s)},move:(t,e,s)=>{this.setByCoordinates(e,this.withoutCoordinates(t),s),this.emptyCell(t,s)},take:(t,e,s)=>{this.setByCoordinates(e,this.withoutCoordinates(t),s),this.emptyCell(t,s)}},this.values_computers={is_enemy:(t,e)=>t.player!=e.player},this.entities_getters={cell:t=>this.unpackBoard(t)},this.conditions_types={exists:t=>Boolean(t.length)},this.state_data_getters={check_win:()=>{const t=this.getCurrentPlayer(),e=this.state.config.win_conditions[t];for(const t of e){const e=this.entities_getters[t.entity](board).filter((e=>matchDict(e,t.filter)));return this.conditions_types[t.type](e)===t.result}}}}componentDidMount(){this.startGame()}startGame(){this.setGameState(this.state.config.initial_game_state)}setGameState(t){this.state.config.game_states[t]&&this.setState((e=>({game_state:t})),(()=>console.log("game_state:",this.state.game_state)))}withoutData(t){const e=this.state.config.cell,s={};for(const i of e)s[i]=t[i];return s}getCurrentPlayer(){const t=this.getCurrentGameStateInfo();if(t)return t.parameters.player}withoutCoordinates(t){const e=Object.assign({},t),s=this.state.config.cell;for(const t of s)delete e[t];return e}onConfigTextChange(t){const e=t.target.value;this.setState({config_text:e})}setByCoordinates(t,e,s,i=!0){const n=this.state.config.cell.map((e=>t[e]));let o=s;for(let t=0;t<n.length-1;t++){const e=n[t];if(!o[e]){if(!i)return;o[e]={}}o=o[e]}const a=n[n.length-1];(o[a]||i)&&(o[a]=e)}emptyCell(t,e){this.setByCoordinates(t,this.withoutData(t),e)}getByCoordinates_(t,e,s){const i=t.map((t=>e[t]));let n=s;for(let t=0;t<i.length-1;t++){const e=i[t];if(!n[e])return;n=n[e]}const o=i[i.length-1];return void 0!==n[o]?[n,o]:void 0}getByCoordinates(t,e,s){const i=this.getByCoordinates_(t,e,s);return i?i[0][i[1]]:void 0}placeFiguresOnBoard(t,e,s){const i={};for(const t of s)this.emptyCell(t,i);for(const t in e)for(const s in e[t])for(const n of e[t][s])this.setByCoordinates(n,{player:t,figure:s},i,!1);return i}unpackBoard(t,e){return getAllElementsWithDepth(this.state.board,t.length-1).map((e=>Object.assign(e.element,dictFromTwoLists(t,e.keys))))}compile_(){const t=JSON.parse(this.state.config_text);return{config:t,position:t.initial_position,board:this.placeFiguresOnBoard(t.cell,t.initial_position,t.board)}}compile(){JSON.parse(this.state.config_text);this.setState(this.compile_())}getCellsDelta(t,e,s){const i={};for(name of t){s[name]-e[name]&&(i[name]=s[name]-e[name])}return i}isDivider(t,e,s){let i;for(let n=0;n<t.length;n++){const o=t[n];if(e[o]&&!s[o]||!e[o]&&s[o])return!1;if(void 0===e[o]||void 0===s[o])continue;const a=e[o]/s[o];if(a!=Math.floor(a))return!1;if(i){if(a!=i)return!1}else{if(i=a,s.also_reversed){if(Math.abs(i)>1&&!s.repeat)return!1;continue}if(i>0&&i>1&&!s.repeat)return!1;if(i<0&&(!s.also_reversed||i<-1&&!s.repeat))return!1}}return{coefficient:i}}computeValues(t,e,s){const i={};for(const n of t)this.values_computers[n]&&(i[n]=this.values_computers[n](e,s));return i}getActionsForCell(t,e,s,i,n){const o=i.cell_actions||s.cell_actions;if(!o)return!1;const a=o[n];if(!a)return!1;const r=[];for(const s of a){if(s.if){if(s.if.given&&!matchDict(t,s.if.given))continue;if(s.if.computed){if(!matchDict(this.computeValues(Object.keys(s.if.computed),t,e),s.if.computed))continue}}r.push(s.action)}return 0!==r.length&&(!r.includes("cancel")&&{actions:r})}getCellAfterSteps(t,e,s,i){const n={};for(const o of t){const t=s[o]?s[o]:0;n[o]=e[o]+t*i}return n}canMove(t,e){const s=t.figure;if(!s)return!1;if(isObjectsEqual(t,e))return!1;const i=this.state.config.figures[s],n=i.movement,o=isDict(n)?n[t.player]:n,a=this.state.config.cell,r=this.getCellsDelta(a,t,e);for(const s of o){var c;const n=null===(c=this.isDivider(a,r,s))||void 0===c?void 0:c.coefficient;if(n){if(e.figure)return this.getActionsForCell(e,t,i,s,"destination");const o=[],r=Math.sign(n);for(let e=r;e!=n;e+=r){const n=this.getCellAfterSteps(a,t,s,e),r=this.getByCoordinates(a,n,this.state.board);if(!r.figure)continue;const c=this.getActionsForCell(r,t,i,s,"transition");if(!1===c)return!1;o.push(...c)}return o.length?{actions:o}:{actions:["move"]}}}return!1}makeActions(t,e,s){this.setState((i=>{for(const n of s)this.actions[n]&&this.actions[n](t,e,i.board);return i}))}getCurrentGameStateInfo(){return this.state.config.game_states[this.state.game_state]}getNextGameState(){const t=this.getCurrentGameStateInfo();if("string"==typeof t.next)return t.next;for(const e of t.next){if(matchDict({result:this.state_data_getters[e.state]},e.if))return e.state}}selectCell(t){if(this.state.selected_cell){const e=this.canMove(this.state.selected_cell,t);if(e){this.makeActions(this.state.selected_cell,t,e.actions);const s=this.getNextGameState();this.setGameState(s)}this.setState({selected_cell:void 0})}else{const e=t.player;if(!e)return;e&&e===this.getCurrentGameStateInfo().parameters.player&&this.setState({selected_cell:t})}}render(){const t=this.unpackBoard(this.state.config.cell,this.state.board);return React.createElement("div",{className:"app"},React.createElement(Board,{board:t,selectCell:this.selectCell.bind(this),selected_cell:this.state.selected_cell,cell_coords_names:this.state.config.cell}),React.createElement("div",{className:"config"},React.createElement("textarea",{className:"configText",value:JSON.stringify(this.state.config,null,"\t"),onChange:this.onConfigTextChange.bind(this)}),React.createElement("button",{className:"compileButton",onClick:this.compile.bind(this)},"compile")))}}const rootElement=document.getElementById("root");ReactDOM.render(React.createElement(Root),rootElement);