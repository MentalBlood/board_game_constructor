"use strict";function getAllElementsWithDepth_(t,e,s,i){for(const o of Object.keys(t)){const n=Number.parseInt(o,10),c=t[n],r=i.concat([n]);0==e?s.push({keys:r,element:c}):getAllElementsWithDepth_(c,e-1,s,r)}}function getAllElementsWithDepth(t,e){const s=[];return getAllElementsWithDepth_(t,e,s,[]),s}function dictFromTwoLists(t,e){const s={};for(let i=0;i<t.length;i++)s[t[i]]=e[i];return s}class Root extends React.Component{constructor(t){super(t),this.state={board:void 0,selected_cell:void 0,config_text:void 0,config:default_config},this.state.config_text=JSON.stringify(this.state.config),this.state=Object.assign(this.state,this.compile_()),this.actions={swap:(t,e,s)=>{this.setByCoordinates(t,e,s),this.setByCoordinates(e,t,s)},move:(t,e,s)=>{this.setByCoordinates(e,this.withoutCoordinates(t),s),this.emptyCell(t,s)},take:(t,e,s)=>{this.setByCoordinates(e,this.withoutCoordinates(t),s),this.emptyCell(t,s)}},this.values_computers={is_enemy:(t,e)=>t.player!=e.player}}withoutData(t){const e=this.state.config.cell,s={};for(const i of e)s[i]=t[i];return s}withoutCoordinates(t){const e=Object.assign({},t),s=this.state.config.cell;for(const t of s)delete e[t];return e}onConfigTextChange(t){const e=t.target.value;this.setState({config_text:e})}setByCoordinates(t,e,s,i=!0){const o=this.state.config.cell.map((e=>t[e]));let n=s;for(let t=0;t<o.length-1;t++){const e=o[t];if(!n[e]){if(!i)return;n[e]={}}n=n[e]}const c=o[o.length-1];(n[c]||i)&&(n[c]=e)}emptyCell(t,e){this.setByCoordinates(t,this.withoutData(t),e)}getByCoordinates_(t,e,s){const i=t.map((t=>e[t]));let o=s;for(let t=0;t<i.length-1;t++){const e=i[t];if(!o[e])return;o=o[e]}const n=i[i.length-1];return void 0!==o[n]?[o,n]:void 0}getByCoordinates(t,e,s){const i=this.getByCoordinates_(t,e,s);return i?i[0][i[1]]:void 0}placeFiguresOnBoard(t,e,s){const i={};for(const t of s)this.emptyCell(t,i);for(const t in e)for(const s in e[t])for(const o of e[t][s])this.setByCoordinates(o,{player:t,figure:s},i,!1);return i}unpackBoard(t,e){return getAllElementsWithDepth(this.state.board,t.length-1).map((e=>Object.assign(e.element,dictFromTwoLists(t,e.keys))))}compile_(){const t=JSON.parse(this.state.config_text);return{config:t,position:t.initial_position,board:this.placeFiguresOnBoard(t.cell,t.initial_position,t.board)}}compile(){JSON.parse(this.state.config_text);this.setState(this.compile_(),(()=>this.forceUpdate()))}getCellsDelta(t,e,s){const i={};for(name of t){s[name]-e[name]&&(i[name]=s[name]-e[name])}return i}isDivider(t,e,s){let i;for(let o=0;o<t.length;o++){const n=t[o];if(e[n]&&!s[n]||!e[n]&&s[n])return!1;if(void 0===e[n]||null==s[n])continue;const c=e[n]/s[n];if(c!=Math.floor(c))return!1;if(i){if(c!=i)return!1}else{if(i=c,s.also_reversed){if(Math.abs(i)>1&&!s.repeat)return!1;continue}if(i>0&&i>1&&!s.repeat)return!1;if(i<0&&(!s.also_reversed||i<-1&&!s.repeat))return!1}}return{coefficient:i}}matchDict(t,e){for(const s in e)if(t[s]!=e[s])return!1;return!0}computeValues(t,e,s){const i={};for(const o of t)this.values_computers[o]&&(i[o]=this.values_computers[o](e,s));return i}getActionsForCell(t,e,s,i,o){const n=i.cell_actions||s.cell_actions;if(!n)return!1;const c=n[o];if(!c)return!1;const r=[];for(const s of c){if(s.if){if(s.if.given&&!this.matchDict(t,s.if.given))continue;if(s.if.computed){const i=this.computeValues(Object.keys(s.if.computed),t,e);if(!this.matchDict(i,s.if.computed))continue}}r.push(s.action)}return 0!=r.length&&(!r.includes("cancel")&&{actions:r})}getCellAfterSteps(t,e,s,i){const o={};for(const n of t){const t=s[n]?s[n]:0;o[n]=e[n]+t*i}return o}canMove(t,e){console.log("canMove",t,e);const s=t.figure;if(!s)return!1;if(isObjectsEqual(t,e))return!1;const i=this.state.config.figures[s],o=i.movement,n=isDict(o)?o[t.player]:o,c=this.state.config.cell,r=this.getCellsDelta(c,t,e);for(const s of n){var l;const o=null===(l=this.isDivider(c,r,s))||void 0===l?void 0:l.coefficient;if(o){if(e.figure)return this.getActionsForCell(e,t,i,s,"destination");const n=[],r=Math.sign(o);for(let e=r;e!=o;e+=r){const o=this.getCellAfterSteps(c,t,s,e),r=this.getByCoordinates(c,o,this.state.board);if(!r.figure)continue;const l=this.getActionsForCell(r,t,i,s,"transition");if(!1===l)return!1;n.push(...l)}return n.length?{actions:n}:{actions:["move"]}}}return!1}makeActions(t,e,s){this.setState((i=>{for(const o of s)this.actions[o]&&this.actions[o](t,e,i.board);return i}))}selectCell(t){if(this.state.selected_cell){const e=this.canMove(this.state.selected_cell,t);e&&this.makeActions(this.state.selected_cell,t,e.actions),this.setState({selected_cell:void 0})}else this.setState({selected_cell:t})}render(){const t=this.unpackBoard(this.state.config.cell,this.state.board);return React.createElement("div",{className:"app"},React.createElement(Board,{board:t,selectCell:this.selectCell.bind(this),selected_cell:this.state.selected_cell,cell_coords_names:this.state.config.cell}),React.createElement("div",{className:"config"},React.createElement("textarea",{className:"configText",value:JSON.stringify(this.state.config,null,"\t"),onChange:this.onConfigTextChange.bind(this)}),React.createElement("button",{className:"compileButton",onClick:this.compile.bind(this)},"compile")))}}const rootElement=document.getElementById("root");ReactDOM.render(React.createElement(Root),rootElement);