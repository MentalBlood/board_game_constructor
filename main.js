"use strict";function getAllElementsWithDepth_(t,e,s,o){for(const i of Object.keys(t)){const n=Number.parseInt(i,10),a=t[n],c=o.concat([n]);0===e?s.push({keys:c,element:a}):getAllElementsWithDepth_(a,e-1,s,c)}}function getAllElementsWithDepth(t,e){const s=[];return getAllElementsWithDepth_(t,e,s,[]),s}function dictFromTwoLists(t,e){const s={};for(let o=0;o<t.length;o++)s[t[o]]=e[o];return s}function matchDict(t,e){for(const s in e)if(t[s]!=e[s])return!1;return!0}class Root extends React.Component{constructor(t){super(t),this.state={board:void 0,game_state:void 0,selected_cell:void 0,config_text:void 0,config:default_config},this.state.config_text=JSON.stringify(this.state.config),this.state=Object.assign(this.state,this.compile_()),this.actions={swap:(t,e,s)=>{this.setCellByCoordinates(t,e,s),this.setCellByCoordinates(e,t,s)},move:(t,e,s)=>{this.setCellByCoordinates(e,this.withoutCoordinates(t),s),this.setCellEmpty(t,s)},take:(t,e,s)=>{this.setCellByCoordinates(e,this.withoutCoordinates(t),s),this.setCellEmpty(t,s)}},this.values_computers={is_enemy:(t,e)=>t.player!=e.player},this.entities_getters={cell:t=>this.composeUnpackedBoard(this.state.config.cell,t)},this.conditions_types={exists:t=>Boolean(t.length)},this.state_data_getters={check_win:t=>{const e=this.getCurrentPlayer(),s=this.state.config.win_conditions[e];for(const e of s){const s=this.entities_getters[e.entity](t).filter((t=>matchDict(t,e.filter)));return this.conditions_types[e.type](s)===e.result}}},this.game_state_passiveness_by_type={move:"active",check_win:"passive",end:"active"}}componentDidMount(){this.startGame()}startGame(){this.setGameState(this.state.config.initial_game_state)}setGameState(t){this.state.config.game_states[t]&&this.setState((e=>({game_state:t})),(()=>console.log("setGameState:",this.state.game_state)))}composeCellWithoutData(t){const e=this.state.config.cell,s={};for(const o of e)s[o]=t[o];return s}getCurrentPlayer(){const t=this.getCurrentGameStateInfo();if(t)return t.parameters.player}withoutCoordinates(t){const e=Object.assign({},t),s=this.state.config.cell;for(const t of s)delete e[t];return e}hangleConfigTextChange(t){const e=t.target.value;this.setState({config_text:e})}setCellByCoordinates(t,e,s,o=!0){const i=this.state.config.cell.map((e=>t[e]));let n=s;for(let t=0;t<i.length-1;t++){const e=i[t];if(!n[e]){if(!o)return;n[e]={}}n=n[e]}const a=i[i.length-1];(n[a]||o)&&(n[a]=e)}setCellEmpty(t,e){this.setCellByCoordinates(t,this.composeCellWithoutData(t),e)}getCellByCoordinates_(t,e,s){const o=t.map((t=>e[t]));let i=s;for(let t=0;t<o.length-1;t++){const e=o[t];if(!i[e])return;i=i[e]}const n=o[o.length-1];return void 0!==i[n]?[i,n]:void 0}getCellByCoordinates(t,e,s){const o=this.getCellByCoordinates_(t,e,s);return o?o[0][o[1]]:void 0}composeBoardWithFigures(t,e,s){const o={};for(const t of s)this.setCellEmpty(t,o);for(const t in e)for(const s in e[t])for(const i of e[t][s])this.setCellByCoordinates(i,{player:t,figure:s},o,!1);return o}composeUnpackedBoard(t,e){return getAllElementsWithDepth(this.state.board,t.length-1).map((e=>Object.assign(e.element,dictFromTwoLists(t,e.keys))))}compile_(){const t=JSON.parse(this.state.config_text);return{config:t,position:t.initial_position,board:this.composeBoardWithFigures(t.cell,t.initial_position,t.board)}}compile(){JSON.parse(this.state.config_text);this.setState(this.compile_())}getCellsDelta(t,e,s){const o={};for(name of t){s[name]-e[name]&&(o[name]=s[name]-e[name])}return o}isVectorDividedByAnother(t,e,s){let o;for(let i=0;i<t.length;i++){const n=t[i];if(e[n]&&!s[n]||!e[n]&&s[n])return!1;if(void 0===e[n]||void 0===s[n])continue;const a=e[n]/s[n];if(a!=Math.floor(a))return!1;if(o){if(a!=o)return!1}else{if(o=a,s.also_reversed){if(Math.abs(o)>1&&!s.repeat)return!1;continue}if(o>0&&o>1&&!s.repeat)return!1;if(o<0&&(!s.also_reversed||o<-1&&!s.repeat))return!1}}return{coefficient:o}}composeComputedValues(t,e,s){const o={};for(const i of t)this.values_computers[i]&&(o[i]=this.values_computers[i](e,s));return o}composeActionsForCell(t,e,s,o,i){const n=o.cell_actions||s.cell_actions;if(!n)return!1;const a=n[i];if(!a)return!1;const c=[];for(const s of a){if(s.if){if(s.if.given&&!matchDict(t,s.if.given))continue;if(s.if.computed){if(!matchDict(this.composeComputedValues(Object.keys(s.if.computed),t,e),s.if.computed))continue}}c.push(s.action)}return 0!==c.length&&(!c.includes("cancel")&&{actions:c})}composeCellAfterSteps(t,e,s,o){const i={};for(const n of t){const t=s[n]?s[n]:0;i[n]=e[n]+t*o}return i}isAllowedMove(t,e){const s=t.figure;if(!s)return!1;if(isObjectsEqual(t,e))return!1;const o=this.state.config.figures[s],i=o.movement,n=isDict(i)?i[t.player]:i,a=this.state.config.cell,c=this.getCellsDelta(a,t,e);for(const s of n){var r;const i=null===(r=this.isVectorDividedByAnother(a,c,s))||void 0===r?void 0:r.coefficient;if(i){if(e.figure)return this.composeActionsForCell(e,t,o,s,"destination");const n=[],c=Math.sign(i);for(let e=c;e!=i;e+=c){const i=this.composeCellAfterSteps(a,t,s,e),c=this.getCellByCoordinates(a,i,this.state.board);if(!c.figure)continue;const r=this.composeActionsForCell(c,t,o,s,"transition");if(!1===r)return!1;n.push(...r)}return n.length?{actions:n}:{actions:["move"]}}}return!1}composeStateAfterActions(t,e,s,o){for(const i of o)this.actions[i]&&this.actions[i](e,s,t.board);return t}getCurrentGameStateInfo(){return this.state.config.game_states[this.state.game_state]}getGameStateInfo(t){return this.state.config.game_states[t]}composeNextGameState(t){const e=this.getGameStateInfo(t);if("string"==typeof e.next)return e.next;const s=this.state_data_getters[e.type](this.state.board);for(const t of e.next)if(matchDict({result:s},t.if))return t.state}setNextGameState(){const t=this.state.game_state;let e=this.composeNextGameState(t);for(;;){const t=this.getGameStateInfo(e).type;if("passive"!=this.game_state_passiveness_by_type[t])break;e=this.composeNextGameState(e)}this.setGameState(e)}handleSelectCell(t){if(this.state.selected_cell){const e=this.isAllowedMove(this.state.selected_cell,t);if(e){const s=this.composeStateAfterActions(this.state,this.state.selected_cell,t,e.actions);this.setState(s,(()=>this.setNextGameState()))}this.setState({selected_cell:void 0})}else{var e;const s=t.player;if(!s)return;s&&s===(null===(e=this.getCurrentGameStateInfo().parameters)||void 0===e?void 0:e.player)&&this.setState({selected_cell:t})}}render(){const t=this.composeUnpackedBoard(this.state.config.cell,this.state.board);return React.createElement("div",{className:"app"},React.createElement(Board,{board:t,handleSelectCell:this.handleSelectCell.bind(this),selected_cell:this.state.selected_cell,cell_coords_names:this.state.config.cell}),React.createElement("div",{className:"config"},React.createElement("textarea",{className:"configText",value:JSON.stringify(this.state.config,null,"\t"),onChange:this.hangleConfigTextChange.bind(this)}),React.createElement("button",{className:"compileButton",onClick:this.compile.bind(this)},"compile")))}}const rootElement=document.getElementById("root");ReactDOM.render(React.createElement(Root),rootElement);